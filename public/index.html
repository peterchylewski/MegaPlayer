<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	
	<title>MPLayerTunez</title>

	<link rel="stylesheet" href="styles/vendor/bootstrap/bootstrap.min.css">
	<link rel="stylesheet" href="styles/elusive-webfont.css">
	<link rel="stylesheet" href="styles/vendor/font-awesome/css/font-awesome.min.css">
	
	<link rel="stylesheet" href="styles/vendor/treetable/jquery.treetable.css">
	<link rel="stylesheet" href="styles/vendor/treetable/jquery.treetable.theme.default.css">
	
	<link rel="stylesheet" href="styles/fonts/Franklin/Franklin.font.css">
	
	<style media="screen">
			
		* {
			-webkit-font-smoothing: antialiased;
			text-rendering: optimizeLegibility;
			margin: 0;
			padding: 0;
			outline: 0 !important;
			-moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;
		}

		body {
			font-family: "FranklinGothicFSBook" !important;
			/* text-transform: lowercase; */
			margin: 32px;
			color: #333;
			background: #fff;
		}
		
		h1, h2, h3, h4, h5, h6 {
			font-family: "FranklinGothicFSHeavy" !important;
			font-weight: 400 !important;
			font-style: normal !important;
			margin: 0 !important;
		}
		
		h1 { font-size: 3em; letter-spacing: -.01em; color: } h2 { font-size: 1.8em; } h6 { font-size: 1em; }
		
		h1 {
			font-size: 6em;
			line-height: .85em;
			letter-spacing: -.045em;
			word-spacing: -.004em;
			color: #D3D3D3;
		}
		
		h2 { color: #D3D3D3; }
	
		* + h1, * + h2, * + h3, * + h4, * + h5, * + h6 { margin-top: 16px; }
		
		h6 {
			/* font-size: 1.61em; */
			color: rgb(179, 20, 20);
			text-transform: uppercase;
			letter-spacing: -.075em;
		}

		ul, ol { list-style-position: inside; }
		
		* + p { margin-top: 8px; }
		
		ul li {
			list-style-type: none;
			margin: 0;
		}
		
		a {
			color: #D2840B;
			text-decoration: none;
		}
	
		td.name a:hover {
			color: #D2840B;
			text-decoration: none;
			border-bottom: 2px dotted #D2840B;
		}
		
		div#controls { margin-bottom: 32px; }
		
		.nav > li > a { padding: 4px 12px 4px 12px; }
		
		.tab-content { margin-top: 16px; }
		
		/* table#main { width: 100%; } */
		
		td#stations {
			padding-top: 6px;
			min-width: 200px;
		}
		
		td#stations li { white-space: nobreak !important; }
		
		td {
			vertical-align: top;
			border: 0px solid #eee;
		}
		
		td#info { padding-left: 32px; }
		
		table#files td {
			font-size: 1.2em !important;
			padding: 4px 8px 2px 8px !important;
			white-space: nowrap;
		}
		
		table#files h6 { display: inline-block; }
		
		td.tags span { padding: 4px; }
		
		table#files tr.active td * { color: green !important; }
		
		h1 { min-height: 70px; }
		
		.el-icon-volume-up {
			position: relative;
			top: 1px;
			padding-left: 6px;
			display: none;
		}
		
		.fa-cog { color: #aaa !important; }
		
		.el-icon-volume-up.active { display: inline; }
		
		.knob {
			position: fixed;
			top: 8px;
			right: 8px;
		}
		
	</style>
	
	<script src="js/jquery-2.0.3.min.js"></script>
	<script src="js/bootstrap-3.2.0.min.js"></script>
	
	<script src="js/jquery.knob.js"></script>
	<script src="js/jquery.treetable.js"></script>
	<script src="js/jquery.cookie.js"></script>
	
	<script src="js/underscore-min.js"></script>
	<script src="js/socket.io-1.2.1.js"></script>

	<script>

		'use strict';
		
		var socket = io('http://192.168.1.200:3000/'),
			_stations,
			_stationIDs,
			_currentStationID,
			_status = {},
			_$activeRow;
		
		function _setStation(id) {
			if (id !== undefined) {
				_currentStationID = id;
				//socket.emit('cmd', 'setStation', _currentStationID);
				socket.emit('station', _currentStationID);
			}
		}
		
		function _previousStation() {
			var currentIndex = _.indexOf(_stationIDs, _currentStationID),
				nextIndex = currentIndex - 1;
			if (nextIndex < 0 ) { nextIndex = _stationIDs.length - 1 ; }
			_setStation(_stationIDs[nextIndex]);
		}
		
		function _nextStation() {
			var currentIndex = _.indexOf(_stationIDs, _currentStationID),
				nextIndex = currentIndex + 1;
			if (nextIndex >= _stationIDs.length) { nextIndex = 0; }
			_setStation(_stationIDs[nextIndex]);
		}
		
		function _nextFile() {
			console.log('_nextFile');
			console.log('_$activeRow', _$activeRow);
			console.log('_$activeRow.next()', _$activeRow.next());
			_$activeRow.next().find('a').click();
		}
		
		socket.on('radiostations', function(stations) {
			console.log('radio stations received: ', stations);
			
			_stations = stations;
			_stationIDs = _.keys(_stations);
			
			var html = $('#stations.template').html(),
				template = _.template(html);

			$('#streams-tab').html(template({ data: stations }));
			$('a.station').click(function(e) {
				console.log('klik');
				e.preventDefault();
				_setStation($(this).attr('href'));
			});
		});
		
		socket.on('musictree', function(musictree) {
			console.log('musictree', musictree);		
			var html = $('#files.template').html(),
				template = _.template(html),
				currentUUID = 0,
				makeUUID = function() { return currentUUID++; },
				treetableOptions = { expandable: true, column: 0, indent: 16, initialState: 'collapsed', clickableNodeNames: true },
				$table = $(template({ makeUUID: makeUUID, data: { children: [ musictree ] } })).treetable(treetableOptions);
				
			$('#files-tab').html($table);
			$('table#files a').on('click', function(e) {
				e.preventDefault();
				var href = $(this).attr('href'),
					matches = href.match(/\.([0-9a-z]+)$/i),
					extension = matches !== undefined && matches[1] !== undefined ? matches[1].toLowerCase() : '';
				
				_$activeRow = $(this).closest('tr');
				
				console.log('href', href);
				console.log('matches', matches);
				console.log('extension', extension);
				switch (extension) {
					case 'mp3':
					case 'aif':
					case 'wav':
					case 'm4a':
					case 'flac':
					case 'cue':
					case 'ape':
					case 'ogg':
						socket.emit('file', href);
					break;
					case 'jpg':
						$('body').prepend('<img src="' + href + '"/>')
					break;
				}
			});
		});
		
		socket.on('station_id', function(id) {
			console.log('station id', id);
			_currentStationID = id;
			$('li i').removeClass('active');
			$('li[data-id="' + id + '"] i').addClass('active');
		});
		
		socket.on('player_value_changed', function(key, value) {
			//console.log('player_value_changed', key, value);
			_status[key] = value;
			//console.log('_status', JSON.stringify(_status, null, 2));
			switch (key) {
				case 'path':
					console.log('PATH CHANGED', value);
					var $files = $('table#files');
					$files.find('tr').removeClass('active');
					_$activeRow = $files.find('tr[data-path="' + value + '"]');
					_$activeRow.addClass('active');
				break;
				case 'volume':
					console.log('VOLUME CHANGED', value);
					 $('.dial').val(value).trigger('change');
				break;
				case 'timePosition':
					//console.log('timePosition', value);
				break;
			}
		});
		
		socket.on('end_of_file_reached', function() {
			console.log('player says: end of file has been reached.');
			_nextFile();
		});
		
		socket.on('station_message', 	function(msg) { $('h1').text(msg); });
		socket.on('previous_station', 	function() { _previousStation(); });
		socket.on('next_station', 		function() { _nextStation(); });
		socket.on('connection', 		function() { console.log('connected to server'); });
		socket.on('welcome', 			function(msg) { console.log(msg); });
		socket.on('disconnect', 		function() { console.log('disconnected from server'); });
		
		$(document).ready(function() {
			console.log('***ready');
			socket.emit('ready', 'foobar');
			
			$('button[data-action="prev_station"]').click(function() { _previousStation(); });
			$('button[data-action="next_station"]').click(function() { _nextStation(); });
			$('button[data-action="stop"]').click(function() {
				console.log('tsop');
				socket.emit('cmd', 'stop');
			});
			$('button[data-action="reload_tree"]').click(function() {
				$('#files-tab').html('<i class="fa fa-cog fa-2x fa-spin"></i>');
				socket.emit('cmd', 'reloadTree');
			});
			
			$('#files-tab').html('<i class="fa fa-cog fa-2x fa-spin"></i>');
			
			// -- tabs
			
			var tab = $.cookie('lastTab');
			if (tab === undefined) { tab = '#streams-tab'; }
		
			$('.nav-tabs a[href="' + tab + '"]').tab('show');
			
			$('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
				console.log('a tab has been clicked on');
				tab = $(e.target).attr('href');				
				$.cookie('lastTab', tab);
			});
			
			// ------------------ volume knob
			
			$('.dial').val(10).knob({							// http://anthonyterrien.com/knob/
				'change': function(value) {
    				console.log('change', value);
    				
    			},
    			
    			'draw': function(value) {
    				console.log('draw', value);
    			},
    			
    			'release': function(value) {
    				console.log('release', value);
    				socket.emit('volume', value);
    			},
    			
				'min': 0,
    			'max': 100,
    			//'angleArc': 270,
    			//'angleOffset': -135,
    			'width': 80,
    			'height': 80,
    			'fgColor': '#B31414'
    			//'rotation': 'counterclockwise',
    			
    		});
			
		});

	</script>
	
	<script class="template" id="stations" type="text/template">
		<ul>
		<% _.each(data, function(value, key) { %>
			<li data-id="<%= key %>"><a class="station" href="<%= key %>"><%= value.name %><i class="el-icon-volume-up"></a></i></li>
		<% }); %>
		</ul>
	</script>
	
	<script class="template" id="files" type="text/template">
		<% var mUid = makeUUID; %>
		<% var name; %>
		
	 	<table id="files">
			<thead>
				<tr class="header">
					<th>Type</th>
					<th>Name</th>
					<th>Tags</th>
				</tr>
			</thead>
			<tbody>
				<% function row(data, parentID) { %>
					<% _.each(data, function(item, i) { %>
						<% if (item !== undefined && item !== null) { %>
							<% var uid = mUid(); %>
		 					<tr class="<%= item.type %>" data-tt-id="<%= uid %>" data-tt-parent-id="<%= parentID %>" data-path="<%= item.path %>">
		 						<td>
		 							<!--
		 							<% if (item.type === 'file') { %>
	 									<i class="fa fa-file"></i>
	 								<% } else { %>
										<i class="fa fa-folder"></i>
									<% } %>
									-->
									<% name = item.name.replace(/^([0-9\.]+)[- ]+/g, "$1. ").replace(/\.[mp3|flac|wav|m4a|aif|ogg]+$/i, ""); %>
									
									<% if (item.type === 'folder') { %>
										<h6><%= name %></h6>
									<% } else { %>
										<a href="<%= item.path %>"><%= name %></a>
									<% } %>
									
								</td>
								<td class="name">
									<% if (item.type === 'file') { %>
										
									<% } else { %>
									<% } %>
								</td>
								<td class="tags">
									<% if (item.meta !== undefined && item.meta.tags !== undefined) { %>
										<% _.each(item.meta.tags, function(tag, i) { %>
											<span class="label label-success"><%= tag %></span>
										<% }); %>
										
									<% } %>
								<td>
							</tr>
							<% if (item.children !== undefined) { %>
								<% row(item.children, uid); %>
							<% } %>
						<% } %>
					<% }); %>
				<% } %>
	 		<% row(data.children, mUid()); %>
	 		</tbody>
		</table>
	</script>
	
</head>
<body>
	<div id="controls">
		<button class="btn btn-primary btn-small" data-action="prev_station"><i class="fa fa-arrow-up"></i>&nbsp;previous station</button>
		<button class="btn btn-primary" data-action="next_station">next station&nbsp;<i class="fa fa-arrow-down"></i></button>
		<button class="btn btn-warning" data-action="stop">stop</button>
		<button class="btn btn-danger" data-action="reload_tree">reload file tree</button>
		<input type="text" class="dial">
	</div>
	
	<table id="main">
		<tr>
			<td id="stations">
				<ul class="nav nav-tabs">
    				<li class="active"><a href="#streams-tab" data-toggle="tab">Streams</a></li>
   					<li><a href="#files-tab" data-toggle="tab">Files</a></li>
				</ul>
				<div class="tab-content">
					<div class="tab-pane active" id="streams-tab">
						streams
					</div>
					<div class="tab-pane" id="files-tab">
						files
					</div>
				</div>
			</td>
			<td id="info">
				<h1></h1>
			</td>
		</tr>
	</table>

</body>


</html>
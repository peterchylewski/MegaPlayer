


// SimpleWebServer v 0.1 Â© 2014 by peter@boring.ch
// adapted from: http://blog.kevinchisholm.com/javascript/node-js/making-a-simple-http-server-with-node-js-part-iii/

var SimpleWebServer = function(pathToPublicHTML, port, options) {	
	console.log('SimpleWebServer!', pathToPublicHTML, port, options);
	
	var _pathToPublicHTML = pathToPublicHTML,
		_port = port,
		_options = options !== undefined ? options : {};
		
	//step 1) require the modules we need
	var http = require('http'),
		path = require('path'),
		fs = require('fs');

	// helper function handles file verification
	function _getFile(filePath, req, res, page404) {
		console.log('SimpleWebServer._getFile', filePath);
		//console.log(req.headers.accept.indexOf('application/json'));
		
		// does the requested file exist?
		fs.exists(filePath, function(exists) {
		
			//if it does...
			if (exists === true) {
				var extname = path.extname(filePath),
					contentType = 'text/html';
				
				// set correct MIME type	
				switch (extname) {
					case '.js':
						contentType = 'text/javascript';
					break;
					case '.css':
						contentType = 'text/css';
					break;
					case '.ttf':
						contentType = 'application/x-font-ttf';
					break;
					case '.woff':
						contentType = 'application/font-woff';
					break;
					case '.jpg':
					case '.jpeg':
						contentType = 'image/jpeg';
						// header("Content-Length: " .(string)(filesize($sImage)) );
					break;
				}
				
				//read the fiule, run the anonymous function
				fs.readFile(filePath,function(err, contents) {
					if (!err) {
						//if there was no error
						res.writeHead(200, { 'Content-Type': contentType });
						
						//send the contents with the default 200/ok header
						res.end(contents);
					} else {
						//for our own troubleshooting
						console.dir(err);
					};
				});
			} else {
			
				// if the requested file was not found
				// serve-up our custom 404 page
				fs.readFile(page404,function(err, contents) {
					//if there was no error
					if (!err){
						//send the contents with a 404/not found header 
						res.writeHead(404, {'Content-Type': 'text/html'});
						res.end(contents);
					} else {
						//for our own troubleshooting
						console.dir(err);
					};
				});
			};
		});
	};

	// a helper function to handle HTTP requests
	function requestHandler(req, res) {
		var fileName = req.url !== '/' ? req.url : (_options.document !== undefined ?  _options.document : 'index.html'),
			page404 = _pathToPublicHTML + '/404.html';
		
		// call our helper function
		// pass in the path to the file we want,
		// the response object, and the 404 page path
		// in case the requestd file is not found
		_getFile((_pathToPublicHTML + '/' + fileName), req, res, page404);
	};

	http.createServer(requestHandler)
		.listen(_port);
};

module.exports = function(pathToPublicHTML, port, options) {
	new SimpleWebServer(pathToPublicHTML, port, options);
};